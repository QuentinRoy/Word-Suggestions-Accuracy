ARG APP_GIT_SHA

# Use multi-stage build, to get rid of the client's dependencies once it has
# been built.
FROM  mhart/alpine-node:14.2.0 AS build-client
WORKDIR /app/client
COPY ./client/package.json ./client/package-lock.json ./
RUN npm install --production
COPY ./client .
ARG APP_GIT_SHA
RUN REACT_APP_GIT_SHA=$APP_GIT_SHA npm run build

FROM mhart/alpine-node:14.2.0 AS install-server
WORKDIR /app/server
COPY ./control-server .
RUN npm install --production

FROM mhart/alpine-node:slim-14.2.0 AS runtime
WORKDIR /app/server
COPY --from=build-client /app/client/build /app/client
COPY --from=install-server /app/server /app/server
COPY ./client/scripts/endpoints-from-env.js /app/

EXPOSE 80
ENV STATIC_NOT_FOUND_FILE index.html
ENV SERVER_PORT 80
ENV STATIC_FILES /app/client
ENV CONTROL_SERVER_PORT ""
CMD node /app/endpoints-from-env > /app/client/endpoints.json \
  && node /app/server/index.js
